name: Build and Release Kindle Capture

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~\.gradle\caches
          ~\.gradle\wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      shell: bash
      
    - name: Build with Gradle
      run: .\gradlew.bat clean build --stacktrace
      shell: cmd
      
    - name: Create Shadow JAR
      run: .\gradlew.bat shadowJar --stacktrace
      shell: cmd
      
    - name: Create Windows App Image
      run: .\gradlew.bat createWindowsExe --stacktrace
      shell: cmd
      
    - name: Create Windows MSI Installer
      run: .\gradlew.bat createWindowsInstaller --stacktrace
      shell: cmd
      continue-on-error: true
      
    - name: Verify build outputs
      run: |
        Write-Host "=== JAR Files ==="
        if (Test-Path "build/libs") {
          Get-ChildItem "build/libs" | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
        } else {
          Write-Host "build/libs directory not found"
        }
        
        Write-Host "`n=== Distributions ==="
        if (Test-Path "build/distributions") {
          Get-ChildItem "build/distributions" | ForEach-Object { 
            $type = if ($_.PSIsContainer) { "Directory" } else { "File" }
            Write-Host "  $($_.Name) - $type"
          }
        } else {
          Write-Host "build/distributions directory not found"
        }
        
        Write-Host "`n=== MSI Files ==="
        $msiFiles = Get-ChildItem "build/distributions/*.msi" -ErrorAction SilentlyContinue
        if ($msiFiles) {
          $msiFiles | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
        } else {
          Write-Host "No MSI files found"
        }
      shell: powershell
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: kindle-capture-jar
        path: build/libs/kindle-capture-*.jar
        if-no-files-found: warn
        
    - name: Create App Image ZIP
      run: |
        if (Test-Path "build/distributions/KindleCapture") {
          Write-Host "Creating ZIP archive..."
          try {
            # PowerShellでのパス変換
            $sourcePath = "build/distributions/KindleCapture"
            $destinationPath = "build/distributions/KindleCapture-Windows-App.zip"
            
            # ZIP作成
            Compress-Archive -Path "$sourcePath/*" -DestinationPath $destinationPath -Force
            Write-Host "ZIP created successfully: KindleCapture-Windows-App.zip"
            
            # ファイル情報表示
            if (Test-Path $destinationPath) {
              $fileInfo = Get-Item $destinationPath
              Write-Host "File size: $($fileInfo.Length) bytes"
            }
          } catch {
            Write-Host "Failed to create ZIP: $($_.Exception.Message)"
            Write-Host "Error details: $($_.Exception)"
            exit 1
          }
        } else {
          Write-Host "KindleCapture directory not found at: build/distributions/KindleCapture"
          Write-Host "Available files in build/distributions:"
          if (Test-Path "build/distributions") {
            Get-ChildItem "build/distributions" | ForEach-Object { Write-Host "  $($_.Name) ($($_.PSIsContainer ? 'Directory' : 'File'))" }
          } else {
            Write-Host "build/distributions directory does not exist"
          }
        }
      shell: powershell
      
    - name: Upload App Image artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('build/distributions/KindleCapture-Windows-App.zip') != ''
      with:
        name: kindle-capture-app-image
        path: build/distributions/KindleCapture-Windows-App.zip
        if-no-files-found: ignore
        
    - name: Upload MSI Installer artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('build/distributions/*.msi') != ''
      with:
        name: kindle-capture-msi
        path: build/distributions/*.msi
        if-no-files-found: ignore
        
    - name: Upload JAR as backup
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: kindle-capture-jar-backup
        path: build/libs/kindle-capture-*.jar
        if-no-files-found: warn
        
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/libs/kindle-capture-*.jar
          build/distributions/*.msi
          build/distributions/KindleCapture-Windows-App.zip
        body: |
          ## 🎉 Kindle Capture Release
          
          Kindle for PCのページを自動スクリーンショット撮影し、PDFを作成するアプリケーションです。
          
          ### 📥 ダウンロード
          
          **🔧 MSIインストーラー（推奨）**
          - `KindleCapture-*.msi` - Windows用インストーラー
          - スタートメニューに追加、アンインストーラー付き
          - 管理者権限で実行してください
          
          **📁 ポータブル版**
          - `KindleCapture-Windows-App.zip` - 展開して実行
          - インストール不要、Java実行環境込み
          - 展開後 `bin/KindleCapture.exe` を実行
          
          **☕ JAR版**
          - `kindle-capture-*.jar` - Java 17以上が必要
          - `java -jar kindle-capture-*.jar` で実行
          
          ### 🚀 使用方法
          
          1. **Kindle for PC**を起動し、読みたい本を開く
          2. **Kindle Capture**を起動
          3. 「**Kindle Desktopを検出**」をクリック
          4. 「**保存フォルダを選択**」で保存先を指定
          5. 撮影間隔を設定（推奨：3-5秒）
          6. 「**撮影開始**」をクリック
          7. 撮影完了後「**PDFを作成**」をクリック
          
          ### 💻 システム要件
          
          - **OS**: Windows 10/11 (64bit)
          - **アプリ**: Kindle for PC
          - **メモリ**: 512MB以上の空きメモリ
          
          ### ⚠️ 注意事項
          
          - **個人使用限定**: 個人の読書用途に限定してください
          - **著作権遵守**: 撮影した画像の配布は行わないでください
          - **利用規約確認**: Kindle for PCの利用規約をご確認ください
          
          ### 🐛 トラブルシューティング
          
          - **Kindle Desktopが検出されない** → Kindle for PCを起動し、ウィンドウを表示状態にしてください
          - **スクリーンショットが真っ黒** → Kindleウィンドウを最前面に表示してください
          - **アクセス拒否エラー** → 管理者として実行してください
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-cross-platform:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build --stacktrace
      
    - name: Create Shadow JAR
      run: ./gradlew shadowJar --stacktrace
      
    - name: Run tests
      run: ./gradlew test --stacktrace
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-cross-platform
        path: build/reports/tests/test/
        if-no-files-found: ignore
