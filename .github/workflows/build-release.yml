name: Build and Release Kindle Capture

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
      
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~\.gradle\caches
          ~\.gradle\wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      shell: bash
      
    - name: Build with Gradle
      run: .\gradlew.bat clean build --stacktrace
      shell: cmd
      
    - name: Create Shadow JAR
      run: .\gradlew.bat shadowJar --stacktrace
      shell: cmd
      
    - name: Create Windows App Image
      run: |
        echo "Creating Windows App Image with JavaFX support..."
        .\gradlew.bat createWindowsExe --stacktrace --info
        
        echo "Checking created app-image structure..."
        if (Test-Path "build/distributions/KindleCapture") {
          echo "App-image created successfully"
          echo "Contents:"
          Get-ChildItem "build/distributions/KindleCapture" -Recurse | ForEach-Object {
            $relativePath = $_.FullName.Substring((Get-Location).Path.Length + 1)
            if ($_.PSIsContainer) {
              echo "  [DIR]  $relativePath"
            } else {
              echo "  [FILE] $relativePath ($($_.Length) bytes)"
            }
          }
          
          # Runtime modules check
          if (Test-Path "build/distributions/KindleCapture/runtime") {
            echo "Runtime directory found"
            $runtimeModules = Get-ChildItem "build/distributions/KindleCapture/runtime" -Recurse -Filter "*javafx*"
            if ($runtimeModules) {
              echo "JavaFX modules in runtime:"
              $runtimeModules | ForEach-Object { echo "  $($_.Name)" }
            } else {
              echo "WARNING: No JavaFX modules found in runtime"
            }
          }
        } else {
          echo "ERROR: App-image was not created"
        }
      shell: powershell
      
    - name: Prepare for MSI creation
      run: |
        Write-Host "Preparing for MSI creation..."
        
        # Java ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèªã¨çµ‚äº†
        Write-Host "Checking for Java processes..."
        $javaProcesses = Get-Process -Name "java" -ErrorAction SilentlyContinue
        if ($javaProcesses) {
          Write-Host "Found $($javaProcesses.Count) Java processes. Attempting gentle shutdown..."
          $javaProcesses | ForEach-Object { 
            try {
              $_.CloseMainWindow()
              Start-Sleep -Seconds 2
            } catch {
              Write-Host "Could not close process gracefully: $($_.ProcessName)"
            }
          }
          Start-Sleep -Seconds 3
        }
        
        # æ®‹å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        Write-Host "Cleaning up build artifacts..."
        if (Test-Path "build\distributions\KindleCapture") {
          Write-Host "Removing existing KindleCapture directory..."
          try {
            Remove-Item "build\distributions\KindleCapture" -Recurse -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2
          } catch {
            Write-Host "Warning: Could not remove KindleCapture directory: $($_.Exception.Message)"
          }
        }
        
        # æ—¢å­˜MSIãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
        $existingMsi = Get-ChildItem "build\distributions\*.msi" -ErrorAction SilentlyContinue
        if ($existingMsi) {
          Write-Host "Removing existing MSI files..."
          $existingMsi | Remove-Item -Force -ErrorAction SilentlyContinue
        }
        
        Write-Host "MSI preparation completed."
      shell: powershell
      
    - name: Create Windows MSI Installer
      run: |
        echo "Creating MSI installer with enhanced JavaFX support..."
        .\gradlew.bat createWindowsInstaller --stacktrace --info
        
        echo "Verifying MSI creation..."
        $msiFiles = Get-ChildItem "build/distributions/*.msi" -ErrorAction SilentlyContinue
        if ($msiFiles) {
          $msiFiles | ForEach-Object {
            echo "Created MSI: $($_.Name) ($($_.Length) bytes)"
          }
        } else {
          echo "WARNING: No MSI files were created"
          echo "This might be due to jpackage issues or missing dependencies"
          
          # Show jpackage logs if available
          if (Test-Path "build/distributions") {
            echo "Contents of distributions directory:"
            Get-ChildItem "build/distributions" -Recurse | ForEach-Object {
              $type = if ($_.PSIsContainer) { "DIR" } else { "FILE" }
              echo "  [$type] $($_.Name)"
            }
          }
        }
      shell: powershell
      continue-on-error: true
      
    - name: Verify build outputs
      run: |
        Write-Host "=== JAR Files ==="
        if (Test-Path "build/libs") {
          Get-ChildItem "build/libs" | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
        } else {
          Write-Host "build/libs directory not found"
        }
        
        Write-Host "`n=== Distributions ==="
        if (Test-Path "build/distributions") {
          Get-ChildItem "build/distributions" | ForEach-Object { 
            if ($_.PSIsContainer) { 
              $type = "Directory"
            } else { 
              $type = "File"
            }
            Write-Host "  $($_.Name) - $type"
          }
        } else {
          Write-Host "build/distributions directory not found"
        }
        
        Write-Host "`n=== MSI Files ==="
        $msiFiles = Get-ChildItem "build/distributions/*.msi" -ErrorAction SilentlyContinue
        if ($msiFiles) {
          $msiFiles | ForEach-Object { Write-Host "  $($_.Name) - $($_.Length) bytes" }
        } else {
          Write-Host "No MSI files found"
        }
      shell: powershell
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: kindle-capture-jar
        path: build/libs/kindle-capture-*.jar
        if-no-files-found: warn
        
    - name: Create App Image ZIP
      run: |
        Write-Host "Checking for KindleCapture app-image..."
        
        if (Test-Path "build/distributions/KindleCapture") {
          Write-Host "Creating ZIP archive from app-image..."
          try {
            # PowerShellã§ã®ãƒ‘ã‚¹å¤‰æ›
            $sourcePath = "build/distributions/KindleCapture"
            $destinationPath = "build/distributions/KindleCapture-Windows-App.zip"
            
            # ZIPä½œæˆ
            Compress-Archive -Path "$sourcePath/*" -DestinationPath $destinationPath -Force
            Write-Host "ZIP created successfully: KindleCapture-Windows-App.zip"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
            if (Test-Path $destinationPath) {
              $fileInfo = Get-Item $destinationPath
              Write-Host "File size: $($fileInfo.Length) bytes"
            }
          } catch {
            Write-Host "Failed to create ZIP: $($_.Exception.Message)"
            Write-Host "Error details: $($_.Exception)"
            
            # ä»£æ›¿æ¡ˆ: JAR ã‹ã‚‰ç°¡æ˜“å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            Write-Host "Creating alternative JAR-based package..."
            try {
              $jarPath = Get-ChildItem "build/libs/kindle-capture-*.jar" | Select-Object -First 1
              if ($jarPath) {
                $altDir = "build/distributions/KindleCapture-JAR"
                New-Item -ItemType Directory -Path $altDir -Force | Out-Null
                Copy-Item $jarPath.FullName "$altDir/kindle-capture.jar"
                
                # å®Ÿè¡Œç”¨ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆYAMLé©åˆå½¢å¼ï¼‰
                $batLines = @(
                  '@echo off',
                  'echo Starting Kindle Capture...',
                  'java -jar kindle-capture.jar',
                  'pause'
                )
                $batContent = $batLines -join "`r`n"
                Set-Content -Path "$altDir/run.bat" -Value $batContent
                
                # READMEä½œæˆï¼ˆYAMLé©åˆå½¢å¼ï¼‰
                $readmeLines = @(
                  'Kindle Capture - JAR Package',
                  '',
                  'Requirements:',
                  '- Java 17 or later must be installed',
                  '',
                  'Usage:',
                  '1. Double-click ''run.bat'' to start the application',
                  '2. Or run: java -jar kindle-capture.jar',
                  '',
                  'If you encounter issues, please install Java 17+ from:',
                  'https://adoptium.net/'
                )
                $readmeContent = $readmeLines -join "`r`n"
                Set-Content -Path "$altDir/README.txt" -Value $readmeContent
                
                # ZIPä½œæˆ
                Compress-Archive -Path "$altDir/*" -DestinationPath "build/distributions/KindleCapture-JAR-Package.zip" -Force
                Write-Host "Alternative JAR package created: KindleCapture-JAR-Package.zip"
              }
            } catch {
              Write-Host "Failed to create alternative package: $($_.Exception.Message)"
            }
          }
        } else {
          Write-Host "KindleCapture app-image directory not found"
          
          # å†åº¦App Imageä½œæˆã‚’è©¦è¡Œ
          Write-Host "Attempting to recreate app-image..."
          try {
            & ".\gradlew.bat" "createWindowsExe" "--stacktrace"
            
            if (Test-Path "build/distributions/KindleCapture") {
              Write-Host "App-image recreated successfully. Creating ZIP..."
              $sourcePath = "build/distributions/KindleCapture"
              $destinationPath = "build/distributions/KindleCapture-Windows-App.zip"
              Compress-Archive -Path "$sourcePath/*" -DestinationPath $destinationPath -Force
              Write-Host "ZIP created from recreated app-image"
            } else {
              Write-Host "Failed to recreate app-image"
            }
          } catch {
            Write-Host "Failed to recreate app-image: $($_.Exception.Message)"
          }
          
          Write-Host "Available files in build/distributions:"
          if (Test-Path "build/distributions") {
            Get-ChildItem "build/distributions" | ForEach-Object { 
              if ($_.PSIsContainer) { 
                $type = "Directory"
              } else { 
                $type = "File"
              }
              Write-Host "  $($_.Name) ($type)" 
            }
          } else {
            Write-Host "build/distributions directory does not exist"
          }
        }
      shell: powershell
      
    - name: Upload App Image artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('build/distributions/KindleCapture-Windows-App.zip') != '' || hashFiles('build/distributions/KindleCapture-JAR-Package.zip') != ''
      with:
        name: kindle-capture-app-image
        path: |
          build/distributions/KindleCapture-Windows-App.zip
          build/distributions/KindleCapture-JAR-Package.zip
        if-no-files-found: ignore
        
    - name: Upload MSI Installer artifact
      uses: actions/upload-artifact@v4
      if: hashFiles('build/distributions/*.msi') != ''
      with:
        name: kindle-capture-msi
        path: build/distributions/*.msi
        if-no-files-found: ignore
        
    - name: Upload JAR as backup
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: kindle-capture-jar-backup
        path: build/libs/kindle-capture-*.jar
        if-no-files-found: warn
        
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/libs/kindle-capture-*.jar
          build/distributions/*.msi
          build/distributions/KindleCapture-Windows-App.zip
          build/distributions/KindleCapture-JAR-Package.zip
        body: |
          ## ğŸ‰ Kindle Capture Release
          
          Kindle for PCã®ãƒšãƒ¼ã‚¸ã‚’è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ’®å½±ã—ã€PDFã‚’ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
          
          ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          **ğŸ”§ MSIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ï¼ˆæ¨å¥¨ï¼‰**
          - `KindleCapture-*.msi` - Windowsç”¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
          - ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ ã€ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ä»˜ã
          - ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã—ã¦ãã ã•ã„
          
          **ğŸ“ ãƒãƒ¼ã‚¿ãƒ–ãƒ«ç‰ˆ**
          - `KindleCapture-Windows-App.zip` - å®Œå…¨ç‹¬ç«‹å‹ï¼ˆæ¨å¥¨ï¼‰
          - `KindleCapture-JAR-Package.zip` - Javaå®Ÿè¡Œç’°å¢ƒä»˜ã
          - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€Javaå®Ÿè¡Œç’°å¢ƒè¾¼ã¿
          - å±•é–‹å¾Œ `bin/KindleCapture.exe` ã‚’å®Ÿè¡Œï¼ˆAppç‰ˆï¼‰
          - å±•é–‹å¾Œ `run.bat` ã‚’å®Ÿè¡Œï¼ˆJARç‰ˆï¼‰
          
          **â˜• JARç‰ˆ**
          - `kindle-capture-*.jar` - Java 17ä»¥ä¸ŠãŒå¿…è¦
          - `java -jar kindle-capture-*.jar` ã§å®Ÿè¡Œ
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          1. **Kindle for PC**ã‚’èµ·å‹•ã—ã€èª­ã¿ãŸã„æœ¬ã‚’é–‹ã
          2. **Kindle Capture**ã‚’èµ·å‹•
          3. ã€Œ**Kindle Desktopã‚’æ¤œå‡º**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
          4. ã€Œ**ä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ**ã€ã§ä¿å­˜å…ˆã‚’æŒ‡å®š
          5. æ’®å½±é–“éš”ã‚’è¨­å®šï¼ˆæ¨å¥¨ï¼š3-5ç§’ï¼‰
          6. ã€Œ**æ’®å½±é–‹å§‹**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
          7. æ’®å½±å®Œäº†å¾Œã€Œ**PDFã‚’ä½œæˆ**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
          
          ### ğŸ’» ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          
          - **OS**: Windows 10/11 (64bit)
          - **ã‚¢ãƒ—ãƒª**: Kindle for PC
          - **ãƒ¡ãƒ¢ãƒª**: 512MBä»¥ä¸Šã®ç©ºããƒ¡ãƒ¢ãƒª
          
          ### âš ï¸ æ³¨æ„äº‹é …
          
          - **å€‹äººä½¿ç”¨é™å®š**: å€‹äººã®èª­æ›¸ç”¨é€”ã«é™å®šã—ã¦ãã ã•ã„
          - **è‘—ä½œæ¨©éµå®ˆ**: æ’®å½±ã—ãŸç”»åƒã®é…å¸ƒã¯è¡Œã‚ãªã„ã§ãã ã•ã„
          - **åˆ©ç”¨è¦ç´„ç¢ºèª**: Kindle for PCã®åˆ©ç”¨è¦ç´„ã‚’ã”ç¢ºèªãã ã•ã„
          
          ### ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
          
          - **Kindle DesktopãŒæ¤œå‡ºã•ã‚Œãªã„** â†’ Kindle for PCã‚’èµ·å‹•ã—ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤ºçŠ¶æ…‹ã«ã—ã¦ãã ã•ã„
          - **ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãŒçœŸã£é»’** â†’ Kindleã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æœ€å‰é¢ã«è¡¨ç¤ºã—ã¦ãã ã•ã„
          - **ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã‚¨ãƒ©ãƒ¼** â†’ ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-cross-platform:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew clean build --stacktrace
      
    - name: Create Shadow JAR
      run: ./gradlew shadowJar --stacktrace
      
    - name: Run tests
      run: ./gradlew test --stacktrace
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-cross-platform
        path: build/reports/tests/test/
        if-no-files-found: ignore
